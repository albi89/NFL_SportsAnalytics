---
title: 'Team KPIs: NFL Example'
output:
  html_document:
    df_print: paged
---


# 1. Packages

```{r warning = F, message = F}
# install.packages('nflplotR')
# install.packages('randomForest')
# install.packages('ggrepel')
# install.packages('ggimage')
# install.packages('gt')
# remotes::install_github("jthomasmock/gtExtras")

library(tidyverse)
library(modelr)
library(nflreadr)
library(nflplotR)
library(randomForest)
library(ggrepel)
library(ggimage)
library(gt)
library(gtExtras)
```



# 2. Importing data:
Let's use the load_pbp() function to load in play-by-play data from the last three seasons and filter for the regular seasons.

```{r warning = F, message = F}
pbp <- load_pbp(seasons = 2019:2021)

pbp <- pbp %>%
        filter(season_type == "REG")
pbp

```



# 3. Produce a table of outcomes:
Aggregate the data on a team level to produce a table that shows the outcomes of performance of each team: how many games they won, games they tied, games they lost, Points for, and Points against. 

```{r warning = F, message = F}
outcomes <- pbp %>%
  group_by(season, game_id, home_team) %>%
  summarize(
    home_win = if_else(sum(result) > 0, 1, 0),
    home_tie = if_else(sum(result) == 0, 1, 0),
    home_diff = last(result),
    home_pts_for = last(home_score),
    home_pts_against = last(away_score)
  ) %>%
  group_by(season, home_team) %>%
  summarize(
    home_games = n(),
    home_wins = sum(home_win),
    home_ties = sum(home_tie),
    home_diff = sum(home_diff),
    home_pts_for = sum(home_pts_for),
    home_pts_against = sum(home_pts_against)
  ) %>%
  ungroup() %>%
  left_join(
    # away games
    pbp %>%
      group_by(season, game_id, away_team) %>%
      summarize(
        away_win = if_else(sum(result) < 0, 1, 0),
        away_tie = if_else(sum(result) == 0, 1, 0),
        away_diff = last(result)*-1,
        away_pts_for = last(away_score),
        away_pts_against = last(home_score)
      ) %>%
      group_by(season, away_team) %>%
      summarize(
        away_games = n(),
        away_wins = sum(away_win),
        away_ties = sum(away_tie),
        away_diff = sum(away_diff),
        away_pts_for = sum(away_pts_for),
        away_pts_against = sum(away_pts_against)
      ) %>%
      ungroup(),
    by = c("season", "home_team" = "away_team")
  ) %>%
  rename(team = "home_team") %>%
  mutate(
    games = home_games + away_games,
    wins = home_wins + away_wins,
    ties = home_ties + away_ties,
    losses = games - wins - ties,
    point_diff = home_diff + away_diff,
    points_for = home_pts_for + away_pts_for,
    points_against = home_pts_against + away_pts_against) %>%
  select(season, team, games, wins, losses, ties, point_diff, points_for, points_against)

outcomes
```



# 4. Produce a table of metrics
Our KPIs will capture the following: number of passes, number of rushes, number of special team plays, pass yards, rush yards, epa per pass, epa per rush, success per pass, success per rush, yards per pass, yards per rush, and special teams epa per play. This will also be captured both from an offensive and defensive standpoint. 

```{r warning = F, message = F}
metrics <- pbp %>% 
  filter(pass == 1 & !is.na(epa) | rush == 1 & !is.na(epa) | special == 1 & !is.na(epa)
    ) %>% 
  group_by(season, posteam) %>% 
    summarize(
      n_pass = sum(pass),
      n_rush = sum(rush),
      n_special = sum(special),
      pass_yards = sum(yards_gained*pass, na.rm = TRUE),
      rush_yards = sum(yards_gained*rush, na.rm = TRUE),
      epa_per_pass = sum(epa*pass)/n_pass,
      epa_per_rush = sum(epa*rush)/n_rush,
      success_per_pass = sum(pass*epa>0)/n_pass,
      success_per_rush = sum(rush*epa>0)/n_rush,
      y_per_pass = sum(yards_gained*pass, na.rm = TRUE)/n_pass,
      y_per_rush = sum(yards_gained*rush, na.rm = TRUE)/n_rush,
      st_epa_per_play = sum(epa*special)/n_special
    ) %>% 
  left_join(
    pbp %>%
      filter(pass == 1 & !is.na(epa) | rush == 1 & !is.na(epa) | special == 1 & !is.na(epa)
    ) %>% 
  group_by(season, defteam) %>% 
    summarize(
      def_n_pass=sum(pass),
      def_n_rush=sum(rush),
      def_n_special = sum(special),
      def_pass_yards = sum(yards_gained * pass, na.rm = TRUE),
      def_rush_yards = sum(yards_gained * rush, na.rm = TRUE),
      def_epa_per_pass=sum(-epa*pass)/def_n_pass,
      def_epa_per_rush=sum(-epa*rush)/def_n_rush,
      def_success_per_pass=sum(pass*epa>0)/def_n_pass,
      def_success_per_rush=sum(rush*epa>0)/def_n_rush,
      def_y_per_pass = sum(yards_gained*pass, na.rm = TRUE)/def_n_pass,
      def_y_per_rush = sum(yards_gained*rush, na.rm = TRUE)/def_n_rush,
      def_st_epa_per_play = sum(-epa*special)/def_n_special
    ),
  by = c("season", "posteam" = "defteam")
  ) %>% 
  rename(team = "posteam") %>% 
  select(-n_pass, -n_rush, -n_special,-def_n_pass, -def_n_rush, -def_n_special)

metrics %>% 
  arrange(-st_epa_per_play)
```



# 5. Joining the outcomes and metrics tables: 
Let df represent the joining of the two results and metrics tables. 

```{r warning = F, message = F}
# Create dataframe for season long outcomes and stats
df <- outcomes %>% 
  left_join(metrics, by = c("season", "team"))

df
```



Since the 2021 season has 17 games, while 2020 and 2019 have 16 games, we'll create a win percentage column:

```{r}
df <- df %>%
        mutate(Win_pct = wins / games)

df
```



# 6. Correlation Analysis to Identify Team KPIs:
Identify measures of performance that correlate significantly with results. Ideally, the set of KPIs can span these various phases of the game, both offensive and defensive.  

```{r}
df %>%
  select(Win_pct, y_per_rush, y_per_pass, epa_per_rush, epa_per_pass, st_epa_per_play, def_y_per_rush,
         def_y_per_pass, def_epa_per_rush, def_epa_per_pass, def_st_epa_per_play) %>%
  cor() %>%
  data.frame() %>%
  select(Win_pct) %>%
  arrange(-Win_pct)
```



# 7. Let's build a Multiple Linear Regression model that considers all relevant KPIs:
Then we will use step-wise backward selection to remove variables that are not significant or are counter-intuitive. 

```{r}
WinPct_LR_Model <- lm(data = df, Win_pct ~ y_per_rush + y_per_pass + epa_per_rush + epa_per_pass + st_epa_per_play +
                      def_y_per_rush + def_y_per_pass + def_epa_per_rush + def_epa_per_pass + def_st_epa_per_play)
summary(WinPct_LR_Model)
```



Based on above model results, it would make sense to choose the following KPIs:
Offensive: EPA per pass (passing), EPA per rush (rushing), special teams EPA per play (special team)
Defensive: Defensive EPA per pass (passing), Defensive EPA per rush (rushing)

Since the correlation for defensive special teams epa per play was counter-intuitive, we should consider not retaining it as a KPI. Part of what impacts this particular measure is the kicking game, and from a defensive standpoint, you have less control over this. 

The good news here is that all the variables selected for the model were significant. The Adjusted R-square was also high at 0.804. Thus, we can say that 80.40% of the variation in win percentage can be explained by the regression model. 

```{r}
WinPct_LR_Model <- lm(data = df, Win_pct ~ epa_per_pass + epa_per_rush + st_epa_per_play + def_epa_per_pass + def_epa_per_rush)
summary(WinPct_LR_Model)
```



# 8. Examining Actual Win Percentage vs. Expected Win Percentage
First, let's layer on the predicted and residual values from the model and store this as a new table called df_predict 

```{r}
df <- df %>%
        add_predictions(WinPct_LR_Model) %>%
        add_residuals(WinPct_LR_Model) %>%
        rename(x_LR_WinPct = pred, LR_Resid = resid)

df
```



# 9. Build a second model examine it's feature importance to determine most impactful KPIs and KPI cutoffs for Win Pct. 

```{r}
#make this example reproducible
set.seed(32)

#fit the random forest model
WinPct_RF_Model <- randomForest(formula = Win_pct ~ y_per_rush + y_per_pass + epa_per_rush + epa_per_pass + st_epa_per_play +
                                def_y_per_rush + def_y_per_pass + def_epa_per_rush + def_epa_per_pass + def_st_epa_per_play, 
                                data = df)
```



We can see that this RandomForest model lists epa_per_pass and def_epa_per_pass as the two most important features. This is in line with the regression model's outputs where the two largest coefficients correspond to these same two variables.

```{r}
RF_Feature_Importance <- as.data.frame(importance(WinPct_RF_Model))
RF_Feature_Importance %>% 
  arrange(-IncNodePurity)
```

```{r}
df <- df %>% 
        add_predictions(WinPct_RF_Model) %>%
        add_residuals(WinPct_RF_Model) %>% 
        rename(x_RF_WinPct = pred, RF_Resid = resid)
```


# 9. Visualizing NFL Team Data

First, we'll look to do some tabular representations of the data relating to team performance measures. In order to enhance the data visualization, team logos and colors will be used. In this step, we will join that data to our df table. 

```{r}
logos <- nflreadr::load_teams()

df <- df %>%
        inner_join(logos, by = c("team" = "team_abbr"))

df
```



Next, let's filter the data to just look at the 2021 season. 

```{r}
df_2021 <- df %>%
            filter(season == 2021)

df_2021
```



Build a table and add in a rank column to show how teams rank for a particular KPI. Let's look at epa_per_pass.

```{r warning = F, message = F}
df_2021 %>%
  select(team_wordmark, team, wins, losses, ties, epa_per_pass) %>%
  mutate(rank = rank(-epa_per_pass, ties.method = "min")) %>%
  select(rank, everything()) %>%
  arrange(-rank) %>%
  gt::gt() %>%
  fmt_number(columns = "epa_per_pass", decimals = 3) %>%
  gt_img_rows(team_wordmark) %>%
  tab_style(style = list(cell_fill(color = "yellow")),
  locations = gt::cells_body(rows = team == "ATL")) %>%
  tab_header(title = md("Team Rankings of EPA per Pass in the 2021 Season"))
```



Now let's look at epa_per_rush. 

```{r}
df_2021 %>%
  select(team_wordmark, team, wins, losses, ties, epa_per_rush) %>%
  mutate(rank = rank(-epa_per_rush, ties.method = "min")) %>%
  select(rank, everything()) %>%
  arrange(rank) %>%
  gt::gt() %>%
  fmt_number(columns = "epa_per_rush", decimals = 3) %>%
  gt_img_rows(team_wordmark) %>%
  tab_style(style = list(cell_fill(color = "yellow")),
  locations = gt::cells_body(rows = team == "ATL")) %>%
  tab_header(title = md("Team Rankings of EPA per Rush in the 2021 Season"))
```



## Scatterplot visuals
When doing team evaluation, scatterplots can be a good way to show team performance in relation to the rest of the league by looking at the interaction between two variables. This can also help to classify teams according to their strengths/weaknesses.
Let's do a scatterplot of epa_per_pass vs. def_epa_per_pass with points being labeled by teams.

```{r}
 df_2021 %>%
  mutate(selected_team = ifelse(team == "ATL", 1, 0)) %>%
  ggplot(aes(x = epa_per_pass, y = def_epa_per_pass)) +
    geom_point(aes(alpha = selected_team, color = selected_team), size = 12, show.legend = F) +
    geom_abline(slope = -1.5, intercept = c(.4, .3, .2, .1, 0, -.1, -.2, -.3), alpha = .2) +
    geom_hline(aes(yintercept = mean(def_epa_per_pass)), color = "red", linetype = "dashed") +
    geom_vline(aes(xintercept = mean(epa_per_pass)), color = "red", linetype = "dashed") +
    geom_image(aes(image = team_logo_espn), size = 0.05, asp = 16 / 9) +
    labs(x = "Offensive Pass EPA per play",
         y = "Defensive EPA per play",
         title = "2021 NFL Offensive and Defensive Pass EPA per Play") +
  theme_bw() +
  theme(aspect.ratio = 9 / 16,
        plot.title = element_text(size = 12, hjust = 0.5, face = "bold")) +
  scale_colour_gradient(low = "white", high = "yellow")
```



Lastly, as opposed to splitting the scatterplot into four quadrants, it may be preferable to simply look at fitted relationships and teams that may be above or below the fitted line.  Let's produce a scatter plot with team logos using Win Percentage (y) and Expected Win Percentage (x). We'll also include a fitted line and highlight the team of interest. 

```{r}
 df_2021 %>%
  mutate(selected_team = ifelse(team == "ATL", 1, 0)) %>%
  ggplot(aes(x = Win_pct, y = x_LR_WinPct)) +
    geom_point(aes(alpha = selected_team, color = selected_team), size = 12, show.legend = F) +
    geom_smooth(method = lm, se = F) +
    geom_image(aes(image = team_logo_espn), size = 0.05, asp = 16 / 9) +
    labs(x = "Win Percentage",
         y = "Expected Win Percentage (Linear Regression)",
         title = "2021 NFL Expected Win Pct. vs Actual Win Pct. (Linear Regression)") +
  theme_bw() +
  theme(aspect.ratio = 9 / 16,
        plot.title = element_text(size = 12, hjust = 0.5, face = "bold")) +
  scale_colour_gradient(low = "white", high = "yellow")
```



Let's look at the same visual above but from the perspective of the Random Forest model. It also confirms that the Atlanta Falcons are underperforming relative to expectation. 
```{r}
 df_2021 %>%
  mutate(selected_team = ifelse(team == "ATL", 1, 0)) %>%
  ggplot(aes(x = Win_pct, y = x_RF_WinPct)) +
    geom_point(aes(alpha = selected_team, color = selected_team), size = 12, show.legend = F) +
    geom_smooth(method = lm, se = F) +
    geom_image(aes(image = team_logo_espn), size = 0.05, asp = 16 / 9) +
    labs(x = "Win Percentage",
         y = "Expected Win Percentage (Random Forest)",
         title = "2021 NFL Expected Win Pct. vs Actual Win Pct. (Random Forest)") +
  theme_bw() +
  theme(aspect.ratio = 9 / 16,
        plot.title = element_text(size = 12, hjust = 0.5, face = "bold")) +
  scale_colour_gradient(low = "white", high = "yellow")
```


*YOUR TURN*

**A. Produce a Scatterplot only showing teams rush epa per play on the x axis, and pass epa per play on the y axis for the 2021 season**

```{r}
 df_2021 %>%
  mutate(selected_team = ifelse(team == "ATL", 1, 0)) %>%
  ggplot(aes(x = epa_per_rush, y = epa_per_pass)) +
    geom_point(aes(alpha = selected_team, color = selected_team), size = 12, show.legend = F) +
    geom_abline(slope = -1.5, intercept = c(.4, .3, .2, .1, 0, -.1, -.2, -.3), alpha = .2) +
    geom_hline(aes(yintercept = mean(epa_per_pass)), color = "red", linetype = "dashed") +
    geom_vline(aes(xintercept = mean(epa_per_rush)), color = "red", linetype = "dashed") +
    geom_image(aes(image = team_logo_espn), size = 0.05, asp = 16 / 9) +
    geom_smooth(method = lm, se = F) +
    labs(x = "EPA per Rush",
         y = "EPA per Pass",
         title = "2021 NFL EPA per Pass vs. EPA per Rush") +
  theme_bw() +
  theme(aspect.ratio = 9 / 16,
        plot.title = element_text(size = 12, hjust = 0.5, face = "bold")) +
  scale_colour_gradient(low = "white", high = "yellow")
```




```{r}
metrics_atl = metrics %>% filter(team == 'ATL')
metrics_not_atl = metrics %>% filter(team != 'ATL')

df_predict_atl = df %>% filter(team == 'ATL')

df_predict_not_atl = df %>% filter(team != 'ATL')

# get playoff data 
playoff_data = load_pbp(seasons = 2019:2021) %>% filter(season_type == "POST")
playoff_data
```


# Identify ATL in epa per pass
```{r}
df_2021 %>%
  mutate(selected_team = ifelse(team == "ATL", 0.9, 0.3)) %>%
  ggplot(aes(x = epa_per_pass, y = def_epa_per_pass)) +
    geom_point(aes(alpha = selected_team), show.legend = F) +
    geom_hline(aes(yintercept = mean(def_epa_per_pass)), color = "red", linetype = "dashed") +
    geom_vline(aes(xintercept = mean(epa_per_pass)), color = "red", linetype = "dashed") +
    geom_text_repel(aes(label = team, alpha = selected_team), show.legend = F) +
    xlab("EPA per Pass") + 
    ylab("Defensive EPA per Pass") +
    ggtitle("Defensive EPA per Pass vs. EPA per Pass for the 2021 NFL Season")
```

```{r warning = F, message = F}
df_2021 %>%
  select(team_wordmark, team, wins, losses, ties, epa_per_pass) %>%
  mutate(rank = rank(-epa_per_pass, ties.method = "min")) %>%
  select(rank, everything()) %>%
  arrange(-rank) %>%
  gt::gt() %>%
  fmt_number(columns = "epa_per_pass", decimals = 3) %>%
  gt_img_rows(team_wordmark) %>%
  tab_style(style = list(cell_fill(color = "yellow")),
  locations = gt::cells_body(rows = team == "ATL")) %>%
  tab_header(title = md("Team Rankings of EPA per Pass in the 2021 Season"))
```
